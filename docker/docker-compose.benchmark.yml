# Benchmark-specific overrides
# Uses a separate postgres volume and database for benchmark isolation
#
# Usage: docker compose -f docker/docker-compose.yml -f docker/docker-compose.dev.yml -f docker/docker-compose.benchmark.yml --env-file .env up -d
#
# Why dev overlay is needed:
# - Builds local Docker images (:dev tags)
# - Exposes ports for local access (searcher, indexer, ai)
# - Volume mounts for hot reload during development
# - Excludes vllm/caddy profiles not needed for benchmarks
#
# IMPORTANT: This uses a separate volume (postgres_benchmark_data) to isolate
# benchmark data from development data. The postgres container will be recreated
# with an empty database.

x-benchmark-db: &benchmark-db
  DATABASE_NAME: omni_benchmark

services:
  # Postgres uses a separate volume for benchmark isolation
  postgres:
    container_name: omni-postgres-benchmark
    volumes:
      - postgres_benchmark_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: omni_benchmark

  # Redis uses a separate volume for benchmark isolation
  redis:
    container_name: omni-redis-benchmark
    volumes:
      - redis_benchmark_data:/data

  # All services use DATABASE_NAME env var
  migrator:
    environment:
      <<: *benchmark-db

  searcher:
    environment:
      <<: *benchmark-db

  indexer:
    environment:
      <<: *benchmark-db
      RUST_LOG: info

  ai:
    environment:
      <<: *benchmark-db

  web:
    environment:
      <<: *benchmark-db

  google-connector:
    environment:
      <<: *benchmark-db

  slack-connector:
    environment:
      <<: *benchmark-db

  atlassian-connector:
    environment:
      <<: *benchmark-db

  web-connector:
    environment:
      <<: *benchmark-db

volumes:
  postgres_benchmark_data:
  redis_benchmark_data: