# Benchmark overlay â€” layers on top of the base docker-compose.yml
# Does NOT require docker-compose.dev.yml
#
# Usage:
#   docker compose -f docker/docker-compose.yml -f docker/docker-compose.benchmark.yml --env-file .env up -d --build
#
# Only starts: postgres, redis, migrator, searcher, indexer, ai
# Connectors, web, and caddy are disabled via profiles.

x-benchmark-db: &benchmark-db
  DATABASE_HOST: postgres
  DATABASE_PORT: 5432
  DATABASE_USERNAME: omni_bench
  DATABASE_PASSWORD: omni_bench_password
  DATABASE_NAME: omni_benchmark

services:
  postgres:
    container_name: omni-postgres-benchmark
    ports:
      - "5432:5432"
    volumes:
      - postgres_benchmark_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: omni_benchmark
      POSTGRES_USER: omni_bench
      POSTGRES_PASSWORD: omni_bench_password

  redis:
    container_name: omni-redis-benchmark
    ports:
      - "6379:6379"
    volumes:
      - redis_benchmark_data:/data

  migrator:
    image: omni-migrator:bench
    build:
      context: ..
      dockerfile: services/migrations/Dockerfile
    environment:
      <<: *benchmark-db

  searcher:
    image: omni-searcher:bench
    build:
      context: ..
      dockerfile: services/searcher/Dockerfile
    ports:
      - "${SEARCHER_PORT}:${SEARCHER_PORT}"
    environment:
      <<: *benchmark-db

  indexer:
    image: omni-indexer:bench
    build:
      context: ..
      dockerfile: services/indexer/Dockerfile
    ports:
      - "${INDEXER_PORT}:${INDEXER_PORT}"
    environment:
      <<: *benchmark-db
      RUST_LOG: info

  ai:
    image: omni-ai:bench
    build:
      context: ../services/ai
      dockerfile: Dockerfile
    ports:
      - "${AI_SERVICE_PORT}:${AI_SERVICE_PORT}"
    environment:
      <<: *benchmark-db

  # Disable services not needed for benchmarks
  web:
    profiles: [full]
  connector-manager:
    profiles: [full]
  google-connector:
    profiles: [full]
  slack-connector:
    profiles: [full]
  atlassian-connector:
    profiles: [full]
  web-connector:
    profiles: [full]
  github-connector:
    profiles: [full]
  notion-connector:
    profiles: [full]
  hubspot-connector:
    profiles: [full]
  fireflies-connector:
    profiles: [full]
  microsoft-connector:
    profiles: [full]
  caddy:
    profiles: [full]

volumes:
  postgres_benchmark_data:
    name: omni-postgres-benchmark-data 
  redis_benchmark_data:
    name: omni-redis-benchmark-data 

